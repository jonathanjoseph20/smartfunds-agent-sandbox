name: Code Factory Governance

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, labeled, unlabeled]

jobs:
  policy:
    runs-on: ubuntu-latest
    outputs:
      tier: ${{ steps.tier.outputs.tier }}
      workspaces: ${{ steps.impact.outputs.workspaces }}
      run_schema: ${{ steps.impact.outputs.run_schema }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate risk tier from PR body or labels
        id: tier
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_LABELS: ${{ join(github.event.pull_request.labels.*.name, ',') }}
        run: |
          set -euo pipefail
          tier=""

          if [[ "$PR_LABELS" =~ (^|,)tier-([0-3])($|,) ]]; then
            tier="${BASH_REMATCH[2]}"
          elif [[ "$PR_BODY" =~ [Tt]ier[[:space:]]*([0-3]) ]]; then
            tier="${BASH_REMATCH[1]}"
          elif [[ "$PR_BODY" =~ [Rr]isk[[:space:]_-]*[Tt]ier[^0-9]*([0-3]) ]]; then
            tier="${BASH_REMATCH[1]}"
          fi

          if [[ -z "$tier" ]]; then
            echo "Risk tier is missing. Add tier-0..tier-3 label or include Tier N in PR body." >&2
            exit 1
          fi

          echo "tier=$tier" >> "$GITHUB_OUTPUT"

      - name: Detect impacted workspaces
        id: impact
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          set -euo pipefail
          git diff --name-only "$BASE_SHA" "$HEAD_SHA" > changed.txt
          echo "Changed paths:" && cat changed.txt

          node <<'NODE'
          import fs from 'node:fs';

          const changed = fs.readFileSync('changed.txt', 'utf8').split('\n').map((line) => line.trim()).filter(Boolean);
          const mappings = [
            ['apps/api/', '@smartfunds/api'],
            ['apps/web/', '@smartfunds/web'],
            ['packages/shared/', '@smartfunds/shared'],
            ['packages/mission-engine/', '@smartfunds/mission-engine'],
            ['packages/doc-factory/', '@smartfunds/doc-factory'],
            ['packages/compliance/', '@smartfunds/compliance'],
            ['packages/exports/', '@smartfunds/exports']
          ];

          const impacted = new Set();
          let runSchema = false;

          for (const file of changed) {
            for (const [prefix, workspace] of mappings) {
              if (file.startsWith(prefix)) {
                impacted.add(workspace);
              }
            }
            if (file.startsWith('packages/doc-factory/') || file.startsWith('packages/exports/')) {
              runSchema = true;
            }
          }

          fs.appendFileSync(process.env.GITHUB_OUTPUT, `workspaces=${Array.from(impacted).join(',')}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `run_schema=${runSchema ? 'true' : 'false'}\n`);
          NODE

      - name: Report policy resolution
        run: |
          echo "Tier: ${{ steps.tier.outputs.tier }}"
          echo "Impacted workspaces: ${{ steps.impact.outputs.workspaces }}"
          echo "Run schema checks: ${{ steps.impact.outputs.run_schema }}"

  lint_tier0:
    needs: policy
    if: needs.policy.outputs.tier == '0'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      - run: npm ci
      - name: Tier 0 lint/typecheck for impacted workspaces
        env:
          WORKSPACES: ${{ needs.policy.outputs.workspaces }}
        run: |
          set -euo pipefail
          if [[ -z "$WORKSPACES" ]]; then
            npm run typecheck --workspaces --if-present
            exit 0
          fi
          shopt -s globstar nullglob
          IFS=',' read -ra items <<< "$WORKSPACES"
          for ws in "${items[@]}"; do
            [[ -z "$ws" ]] && continue
            has_typecheck=$(npm pkg get scripts.typecheck --workspace "$ws" | tr -d '"')
            if [[ "$has_typecheck" != "{}" ]]; then
              npm --workspace "$ws" run typecheck
            fi
          done

  unit_tests:
    needs: policy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      - run: npm ci
      - name: Run unit test command for impacted workspaces
        env:
          WORKSPACES: ${{ needs.policy.outputs.workspaces }}
        run: |
          set -euo pipefail
          if [[ -z "$WORKSPACES" ]]; then
            npm --workspace @smartfunds/doc-factory run test
            exit 0
          fi
          IFS=',' read -ra items <<< "$WORKSPACES"
          ran_any=0
          for ws in "${items[@]}"; do
            [[ -z "$ws" ]] && continue
            has_test=$(npm pkg get scripts.test --workspace "$ws" | tr -d '"')
            if [[ "$has_test" != "{}" ]]; then
              npm --workspace "$ws" run test
              ran_any=1
            fi
          done
          if [[ "$ran_any" -eq 0 ]]; then
            npm --workspace @smartfunds/doc-factory run test
          fi

  integration_tests:
    needs: policy
    if: needs.policy.outputs.tier == '2' || needs.policy.outputs.tier == '3'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      - run: npm ci
      - name: Run integration tests for impacted workspaces
        env:
          WORKSPACES: ${{ needs.policy.outputs.workspaces }}
        run: |
          set -euo pipefail
          if [[ -z "$WORKSPACES" ]]; then
            echo "No impacted workspaces. Integration step skipped."
            exit 0
          fi
          shopt -s globstar nullglob
          IFS=',' read -ra items <<< "$WORKSPACES"
          for ws in "${items[@]}"; do
            [[ -z "$ws" ]] && continue
            pkg_path=""
            case "$ws" in
              @smartfunds/doc-factory) pkg_path="packages/doc-factory" ;;
              @smartfunds/mission-engine) pkg_path="packages/mission-engine" ;;
              @smartfunds/api) pkg_path="apps/api" ;;
              @smartfunds/shared) pkg_path="packages/shared" ;;
              @smartfunds/compliance) pkg_path="packages/compliance" ;;
              @smartfunds/exports) pkg_path="packages/exports" ;;
              @smartfunds/web) pkg_path="apps/web" ;;
            esac
            [[ -z "$pkg_path" || ! -d "$pkg_path" ]] && continue
            if compgen -G "$pkg_path/**/*.integration.test.ts" > /dev/null; then
              npm --workspace "$ws" run test -- "**/*.integration.test.ts"
            fi
          done

  schema_checks:
    needs: policy
    if: needs.policy.outputs.tier == '2' || needs.policy.outputs.tier == '3'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      - run: npm ci
      - name: Run schema/type checks when doc/export paths are touched
        if: needs.policy.outputs.run_schema == 'true'
        run: |
          set -euo pipefail
          if [[ -d packages/doc-factory ]]; then
            npm --workspace @smartfunds/doc-factory run typecheck
          fi
          if [[ -d packages/exports ]]; then
            npm --workspace @smartfunds/exports run typecheck
          fi

  tier3_label_gate:
    needs: policy
    if: needs.policy.outputs.tier == '3'
    runs-on: ubuntu-latest
    steps:
      - name: Require tier-3-approved label
        env:
          PR_LABELS: ${{ join(github.event.pull_request.labels.*.name, ',') }}
        run: |
          set -euo pipefail
          if [[ ",$PR_LABELS," != *",tier-3-approved,"* ]]; then
            echo "Tier 3 PRs require 'tier-3-approved' label from maintainers." >&2
            exit 1
          fi
